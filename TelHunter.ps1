$env:DOTNET_CLI_TELEMETRY_OPTOUT=1
$env:POWERSHELL_TELEMETRY_OPTOUT=1
$env:NUGET_TELEMETRY_OPTOUT=1
$env:AZURE_CORE_COLLECT_TELEMETRY=0
if($PSVersionTable.PSEdition -eq 'Core'){Write-Error "Run this script in Windows PowerShell (Desktop), not PowerShell 7/Core (pwsh).";exit 1}
$p=New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent());if(-not $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)){Write-Error "Run this script in an elevated Windows PowerShell session.";exit 1}
function Get-RegValue{param([string]$Path,[string]$Name)try{if(-not(Test-Path $Path)){return $null};(Get-ItemProperty -Path $Path -Name $Name -ErrorAction SilentlyContinue).$Name}catch{$null}}
function Set-RegValueSafe{param([string]$Path,[string]$Name,[object]$Value,[string]$Type='DWord')try{if(-not(Test-Path $Path)){New-Item -Path $Path -Force|Out-Null};New-ItemProperty -Path $Path -Name $Name -Value $Value -PropertyType $Type -Force|Out-Null;Write-Host ("OK: {0}\{1} = {2} ({3})" -f $Path,$Name,$Value,$Type)}catch{Write-Warning ("Failed to set {0}\{1}: {2}" -f $Path,$Name,$_.Exception.Message)}}
function Set-EnvOptOut{param([string]$Name,[string]$Value)Set-RegValueSafe -Path 'HKCU:\Environment' -Name $Name -Value $Value -Type 'String';Set-RegValueSafe -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment' -Name $Name -Value $Value -Type 'String'}
function Get-ServiceInfo{param([string]$Name)try{$svc=Get-Service -Name $Name -ErrorAction SilentlyContinue;if(-not $svc){return $null};$svcCim=Get-CimInstance -ClassName Win32_Service -Filter ("Name='{0}'" -f $Name) -ErrorAction SilentlyContinue;$startMode=if($svcCim){$svcCim.StartMode}else{$null};[pscustomobject]@{Name=$svc.Name;DisplayName=$svc.DisplayName;Status=$svc.Status.ToString();StartType=$startMode}}catch{$null}}
function Disable-ServiceSafe{param([string]$Name,[ValidateSet('Disabled','Manual','Automatic')][string]$Startup='Disabled')try{$svc=Get-Service -Name $Name -ErrorAction SilentlyContinue;if(-not $svc){Write-Host ("Skip: service {0} not found." -f $Name);return};try{Set-Service -Name $Name -StartupType $Startup -ErrorAction SilentlyContinue}catch{Write-Warning ("Failed to set startup type for {0}: {1}" -f $Name,$_.Exception.Message)};try{if($svc.Status -ne 'Stopped'){Stop-Service -Name $Name -Force -ErrorAction SilentlyContinue}}catch{Write-Warning ("Failed to stop {0}: {1}" -f $Name,$_.Exception.Message)};Write-Host ("OK: service {0} set to {1} and stopped if running." -f $Name,$Startup)}catch{Write-Warning ("Error handling service {0}: {1}" -f $Name,$_.Exception.Message)}}
function Get-TaskInfo{param([string]$Path,[string]$Name)try{$task=Get-ScheduledTask -TaskPath $Path -TaskName $Name -ErrorAction SilentlyContinue;if(-not $task){return $null};[pscustomobject]@{TaskPath=$task.TaskPath;TaskName=$task.TaskName;State=$task.State.ToString();Enabled=$task.Enabled}}catch{$null}}
function Disable-TaskSafe{param([string]$Path,[string]$Name)try{$task=Get-ScheduledTask -TaskPath $Path -TaskName $Name -ErrorAction SilentlyContinue;if(-not $task){Write-Host ("Skip: task {0}{1} not found." -f $Path,$Name);return};Disable-ScheduledTask -TaskPath $Path -TaskName $Name -ErrorAction SilentlyContinue|Out-Null;Write-Host ("OK: task {0}{1} disabled." -f $Path,$Name)}catch{Write-Warning ("Failed to disable task {0}{1}: {2}" -f $Path,$Name,$_.Exception.Message)}}
function Resolve-TelemetryLevel{param([Nullable[int]]$Value)switch($Value){0{'0 - Security (Enterprise-only / Minimal)'}1{'1 - Basic'}2{'2 - Enhanced (legacy)'}3{'3 - Full'}$null{'Not explicitly set (default applies)'}default{"Custom/Unknown ($Value)"}}}
function Get-TelemetryReport{$osCim=$null;try{$osCim=Get-CimInstance Win32_OperatingSystem -ErrorAction SilentlyContinue}catch{};$osInfo=[pscustomobject]@{Caption=if($osCim){$osCim.Caption}else{$null};Version=if($osCim){$osCim.Version}else{$null};Build=if($osCim){$osCim.BuildNumber}else{$null};EditionID=Get-RegValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion' -Name 'EditionID'};$policyAllow=Get-RegValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection' -Name 'AllowTelemetry';$currentAllow=Get-RegValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\DataCollection' -Name 'AllowTelemetry';$diagnosticData=[pscustomobject]@{PolicyAllowTelemetry=$policyAllow;PolicyAllowTelemetryText=Resolve-TelemetryLevel -Value $policyAllow;CurrentAllowTelemetry=$currentAllow;CurrentAllowTelemetryText=Resolve-TelemetryLevel -Value $currentAllow;CommercialId=Get-RegValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\DataCollection' -Name 'CommercialId'};$services=[pscustomobject]@{DiagTrack=Get-ServiceInfo -Name 'DiagTrack';DmwAppPushService=Get-ServiceInfo -Name 'dmwappushservice';DoSvc=Get-ServiceInfo -Name 'DoSvc';WerSvc=Get-ServiceInfo -Name 'WerSvc';PcaSvc=Get-ServiceInfo -Name 'PcaSvc'};$tasks=[pscustomobject]@{AppExp_ProgramDataUpdater=Get-TaskInfo -Path '\Microsoft\Windows\Application Experience\' -Name 'ProgramDataUpdater';AppExp_StartupAppTask=Get-TaskInfo -Path '\Microsoft\Windows\Application Experience\' -Name 'StartupAppTask';CEIP_Consolidator=Get-TaskInfo -Path '\Microsoft\Windows\Customer Experience Improvement Program\' -Name 'Consolidator';CEIP_UsbCeip=Get-TaskInfo -Path '\Microsoft\Windows\Customer Experience Improvement Program\' -Name 'UsbCeip';CEIP_KernelCeip=Get-TaskInfo -Path '\Microsoft\Windows\Customer Experience Improvement Program\' -Name 'KernelCeipTask';WER_QueueReporting=Get-TaskInfo -Path '\Microsoft\Windows\Windows Error Reporting\' -Name 'QueueReporting';Autochk_Proxy=Get-TaskInfo -Path '\Microsoft\Windows\Autochk\' -Name 'Proxy'};$werPolicy=[pscustomobject]@{DisabledPolicy=Get-RegValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting' -Name 'Disabled';DisabledLocal=Get-RegValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\Windows Error Reporting' -Name 'Disabled'};$activityHistory=[pscustomobject]@{PublishUserActivities=Get-RegValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System' -Name 'PublishUserActivities';UploadUserActivities=Get-RegValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System' -Name 'UploadUserActivities';EnableActivityFeed=Get-RegValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System' -Name 'EnableActivityFeed'};$advertisingId=[pscustomobject]@{EnabledCurrentUser=Get-RegValue -Path 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\AdvertisingInfo' -Name 'Enabled'};$tailored=[pscustomobject]@{TailoredExperiencesPolicy=Get-RegValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\CloudContent' -Name 'DisableTailoredExperiencesWithDiagnosticData';TailoredExperiencesUser=Get-RegValue -Path 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Privacy' -Name 'TailoredExperiencesWithDiagnosticDataEnabled'};$edgeTelemetry=[pscustomobject]@{Edge_DiagDataPolicy=Get-RegValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Edge' -Name 'DiagnosticData';Edge_Experiments=Get-RegValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Edge' -Name 'ExperimentsEnabled'};[pscustomobject]@{Timestamp=(Get-Date).ToString('s');ComputerName=$env:COMPUTERNAME;UserName=$env:USERNAME;OS=$osInfo;DiagnosticData=$diagnosticData;Services=$services;TelemetryTasks=$tasks;ErrorReporting=$werPolicy;ActivityHistory=$activityHistory;AdvertisingId=$advertisingId;TailoredExperiences=$tailored;EdgeTelemetry=$edgeTelemetry}}
function Disable-DiagnosticData{Write-Host "Disabling diagnostic data / telemetry level (policy)..." -ForegroundColor Cyan;Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection' -Name 'AllowTelemetry' -Value 0 -Type 'DWord';Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\DataCollection' -Name 'AllowTelemetry' -Value 0 -Type 'DWord'}
function Disable-TelemetryServices{Write-Host "Disabling telemetry-related services..." -ForegroundColor Cyan;Disable-ServiceSafe -Name 'DiagTrack' -Startup 'Disabled';Disable-ServiceSafe -Name 'dmwappushservice' -Startup 'Disabled';Disable-ServiceSafe -Name 'WerSvc' -Startup 'Disabled';Disable-ServiceSafe -Name 'PcaSvc' -Startup 'Disabled';Disable-ServiceSafe -Name 'DoSvc' -Startup 'Manual'}
function Disable-TelemetryTasks{Write-Host "Disabling telemetry / CEIP scheduled tasks..." -ForegroundColor Cyan;Disable-TaskSafe -Path '\Microsoft\Windows\Application Experience\' -Name 'ProgramDataUpdater';Disable-TaskSafe -Path '\Microsoft\Windows\Application Experience\' -Name 'StartupAppTask';Disable-TaskSafe -Path '\Microsoft\Windows\Customer Experience Improvement Program\' -Name 'Consolidator';Disable-TaskSafe -Path '\Microsoft\Windows\Customer Experience Improvement Program\' -Name 'UsbCeip';Disable-TaskSafe -Path '\Microsoft\Windows\Customer Experience Improvement Program\' -Name 'KernelCeipTask';Disable-TaskSafe -Path '\Microsoft\Windows\Windows Error Reporting\' -Name 'QueueReporting';Disable-TaskSafe -Path '\Microsoft\Windows\Autochk\' -Name 'Proxy'}
function Disable-WER{Write-Host "Disabling Windows Error Reporting (WER)..." -ForegroundColor Cyan;Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting' -Name 'Disabled' -Value 1 -Type 'DWord';Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Microsoft\Windows\Windows Error Reporting' -Name 'Disabled' -Value 1 -Type 'DWord'}
function Disable-ActivityHistory{Write-Host "Disabling activity history publishing / upload..." -ForegroundColor Cyan;Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System' -Name 'PublishUserActivities' -Value 0 -Type 'DWord';Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System' -Name 'UploadUserActivities' -Value 0 -Type 'DWord';Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System' -Name 'EnableActivityFeed' -Value 0 -Type 'DWord'}
function Disable-AdvertisingId{Write-Host "Disabling Advertising ID (current user)..." -ForegroundColor Cyan;Set-RegValueSafe -Path 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\AdvertisingInfo' -Name 'Enabled' -Value 0 -Type 'DWord'}
function Disable-TailoredExperiences{Write-Host "Disabling tailored experiences..." -ForegroundColor Cyan;Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\CloudContent' -Name 'DisableTailoredExperiencesWithDiagnosticData' -Value 1 -Type 'DWord';Set-RegValueSafe -Path 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Privacy' -Name 'TailoredExperiencesWithDiagnosticDataEnabled' -Value 0 -Type 'DWord'}
function Disable-EdgeTelemetry{Write-Host "Disabling Edge/Chromium telemetry + CLI opt-outs..." -ForegroundColor Cyan;Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Edge' -Name 'DiagnosticData' -Value 0 -Type 'DWord';Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Edge' -Name 'ExperimentsEnabled' -Value 0 -Type 'DWord';Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Edge' -Name 'MetricsReportingEnabled' -Value 0 -Type 'DWord';Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Edge' -Name 'UserFeedbackAllowed' -Value 0 -Type 'DWord';Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Google\Chrome' -Name 'MetricsReportingEnabled' -Value 0 -Type 'DWord';Set-RegValueSafe -Path 'HKLM:\SOFTWARE\Policies\Google\Chrome' -Name 'UserFeedbackAllowed' -Value 0 -Type 'DWord';Set-EnvOptOut 'DOTNET_CLI_TELEMETRY_OPTOUT' '1';Set-EnvOptOut 'POWERSHELL_TELEMETRY_OPTOUT' '1';Set-EnvOptOut 'NUGET_TELEMETRY_OPTOUT' '1';Set-EnvOptOut 'AZURE_CORE_COLLECT_TELEMETRY' '0'}
Write-Host "=== Windows 11 Telemetry Status (CHECK) ===" -ForegroundColor Yellow;$report=Get-TelemetryReport
Write-Host "`n[OS]" -ForegroundColor Green;$report.OS|Format-List
Write-Host "`n[Diagnostic Data / Telemetry]" -ForegroundColor Green;$report.DiagnosticData|Format-List
Write-Host "`n[Services]" -ForegroundColor Green;$report.Services|Format-List
Write-Host "`n[Telemetry / CEIP Scheduled Tasks]" -ForegroundColor Green;$report.TelemetryTasks|Format-List
Write-Host "`n[Windows Error Reporting]" -ForegroundColor Green;$report.ErrorReporting|Format-List
Write-Host "`n[Activity History]" -ForegroundColor Green;$report.ActivityHistory|Format-List
Write-Host "`n[Advertising ID]" -ForegroundColor Green;$report.AdvertisingId|Format-List
Write-Host "`n[Tailored Experiences]" -ForegroundColor Green;$report.TailoredExperiences|Format-List
Write-Host "`n[Edge Telemetry (Policy)]" -ForegroundColor Green;$report.EdgeTelemetry|Format-List
Write-Host "`n=== Telemetry FIX Options ===" -ForegroundColor Yellow;Write-Host "1) Reduce Diagnostic Data / Telemetry level to minimal (AllowTelemetry=0)";Write-Host "2) Disable telemetry-related services (DiagTrack, dmwappushservice, DoSvc->Manual, WerSvc, PcaSvc)";Write-Host "3) Disable telemetry / CEIP scheduled tasks";Write-Host "4) Disable Windows Error Reporting (WER)";Write-Host "5) Disable Activity History publishing / upload";Write-Host "6) Disable Advertising ID (current user)";Write-Host "7) Disable Tailored Experiences";Write-Host "8) Disable Edge/Chromium telemetry + CLI opt-out env vars";Write-Host "9) Apply ALL of the above";Write-Host "0) Do nothing (exit)";Write-Host ""
$choice=Read-Host "Enter one or more options (e.g. 1,3,5 or 9 or 0)";if(-not $choice){Write-Host "No selection made. Exiting.";exit 0};if($choice -match '(^|[,; ]+)0([,; ]+|$)'){Write-Host "Exit requested. No changes applied.";exit 0}
$selected=$choice -split '[,; ]+'|Where-Object{$_ -match '^[1-9]$'}|Select-Object -Unique;if(-not $selected){Write-Host "No valid options selected. Exiting with no changes.";exit 0};if($selected -contains '9'){$selected='1','2','3','4','5','6','7','8'}
Write-Host ("`nApplying selected fixes: {0}" -f ($selected -join ', ')) -ForegroundColor Yellow;foreach($opt in $selected){switch($opt){'1'{Disable-DiagnosticData}'2'{Disable-TelemetryServices}'3'{Disable-TelemetryTasks}'4'{Disable-WER}'5'{Disable-ActivityHistory}'6'{Disable-AdvertisingId}'7'{Disable-TailoredExperiences}'8'{Disable-EdgeTelemetry}}}
Write-Host "`nDone. Some changes may require sign-out or reboot to fully apply." -ForegroundColor Green
